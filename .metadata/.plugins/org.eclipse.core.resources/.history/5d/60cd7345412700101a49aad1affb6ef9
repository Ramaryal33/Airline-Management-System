package com.airline.controller;

import com.airline.staff.model.Employee;
//import com.airline.staff.service.EmployeeService;
import com.airline.staff.service.EmployeeTaskService;

import jakarta.servlet.*;
import jakarta.servlet.http.*;
import jakarta.servlet.annotation.*;

import java.io.IOException;
import java.sql.SQLException;

@WebServlet("/staffDashboard")
public class StaffDashboardController extends HttpServlet {
    private static final long serialVersionUID = 1L;
//    private final EmployeeService employeeService = new EmployeeService();
    private final EmployeeTaskService employeeTaskService = new EmployeeTaskService();

    public StaffDashboardController() {
        super();
    }

    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        // Check if the user (employee) is already authenticated (in session)
        HttpSession session = request.getSession(false);
        if (session != null && session.getAttribute("staff") != null) {
            // If already logged in, fetch the employee from session
            Employee user = (Employee) session.getAttribute("staff");

            try {
                // Fetch employee data
                int totalHours = employeeTaskService.getTotalWorkedHoursByEmployee(user.getEmployeeId());
                int activeTasks = employeeTaskService.getActiveTaskCountByEmployee(user.getEmployeeId());
                int pendingTasks = employeeTaskService.getPendingTaskCountByEmployee(user.getEmployeeId());

                // Set the attributes to be used in the JSP
                request.setAttribute("pageTitle", "Staff Dashboard - Dawn Airlines");
                request.setAttribute("cssPath", request.getContextPath() + "/css/style.css");
                request.setAttribute("basePath", request.getContextPath());
                request.setAttribute("user", user);
                request.setAttribute("totalHours", totalHours);
                request.setAttribute("activeTasks", activeTasks);
                request.setAttribute("pendingTasks", pendingTasks);

                // Forward to the staff dashboard page (JSP)
                request.getRequestDispatcher("/WEB-INF/page/staffDashboard.jsp").forward(request, response);

            } catch (SQLException e) {
                // Handle SQL exception
                e.printStackTrace();
                response.sendError(HttpServletResponse.SC_INTERNAL_SERVER_ERROR, "Database error occurred.");
            }

        } else {
            // If no user is in session, redirect to login page
            response.sendRedirect("staff.jsp"); // Redirect to the login page
        }
    }

    @Override
    protected void doPost(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        doGet(request, response); // Same logic for POST, so we call doGet
    }
}
