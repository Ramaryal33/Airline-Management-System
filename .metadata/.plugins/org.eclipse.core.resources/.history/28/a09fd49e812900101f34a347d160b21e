<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ taglib uri="jakarta.tags.fmt" prefix="fmt" %>
<%@ page import="java.util.*, com.airline.model.Attendance" %>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dawn Airline Staff Dashboard</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/staff.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="sidebar">
        <h2>Dawn Airline</h2>
        <ul>
            <li><a href="${pageContext.request.contextPath}/staffDashboard" class="active">Dashboard</a></li>
            <li><a href="${pageContext.request.contextPath}/employees">Employees</a></li>
            <li><a href="${pageContext.request.contextPath}/tasks">Tasks</a></li>
            <li><a href="${pageContext.request.contextPath}/reports">Reports</a></li>
            <li><a href="${pageContext.request.contextPath}/settings">Settings</a></li>
        </ul>
    </div>

    <div class="main-content">
        <h2>Welcome, ${staff.firstName} ${staff.lastName}!</h2>

        <% if (request.getAttribute("topPerformer") != null) { %>
            <p>Top Performer: ${topPerformer.name}</p>
            <p>Performance Score: <fmt:formatNumber value="${topPerformer.performanceScore}" maxFractionDigits="0"/>%</p>
        <% } %>

        <div class="cards">
            <div class="card">
                <h3>Total Employees</h3>
                <p><fmt:formatNumber value="${totalEmployees}"/></p>
            </div>
            <div class="card">
                <h3>Total Hours</h3>
                <p><fmt:formatNumber value="${totalHours}" maxFractionDigits="2"/></p>
            </div>
            <div class="card">
                <h3>Active Tasks</h3>
                <p><fmt:formatNumber value="${activeTasks}"/></p>
            </div>
            <div class="card">
                <h3>Pending Tasks</h3>
                <p><fmt:formatNumber value="${pendingTasks}"/></p>
            </div>
        </div>

        <div class="card performance-card">
            <h3>Recent Attendance</h3>
            <div class="attendance-list">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Clock In</th>
                            <th>Clock Out</th>
                            <th>Status</th>
                            <th>Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        <%
                            List<Attendance> attendances = (List<Attendance>) request.getAttribute("recentAttendance");
                            if (attendances != null) {
                                for (Attendance a : attendances) {
                        %>
                        <tr>
                            <td><fmt:formatDate value="<%= a.getDate() %>" pattern="MMM dd, yyyy"/></td>
                            <td><fmt:formatDate value="<%= a.getClockIn() %>" pattern="HH:mm"/></td>
                            <td><fmt:formatDate value="<%= a.getClockOut() %>" pattern="HH:mm"/></td>
                            <td><%= a.getStatus() %></td>
                            <td><fmt:formatNumber value="<%= a.getWorkingHours() %>" maxFractionDigits="2"/></td>
                        </tr>
                        <%      }
                            }
                        %>
                    </tbody>
                </table>
            </div>

            <h3>Performance Overview</h3>
            <%
                Map<String, Integer> performanceMap = (Map<String, Integer>) request.getAttribute("performanceDistribution");
                if (performanceMap != null) {
                    for (Map.Entry<String, Integer> entry : performanceMap.entrySet()) {
                        String label = entry.getKey();
                        int value = entry.getValue();
            %>
            <div class="performance-item">
                <span><%= label %></span>
                <div class="progress-bar">
                    <div class="progress <%= label.toLowerCase() %>" style="width: <%= value * 10 %>%">
                        <%= value * 10 %>%
                    </div>
                </div>
            </div>
            <%
                    }
                }
            %>

            <div class="performance-stats">
                <div class="stat-box">
                    <div class="stat-value">
                        <% if (request.getAttribute("topPerformer") != null) { %>
                            <fmt:formatNumber value="${topPerformer.performanceScore}" maxFractionDigits="0"/>%
                        <% } %>
                    </div>
                    <div class="stat-label">Top Performer</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value"><fmt:formatNumber value="${avgRating}" maxFractionDigits="0"/>%</div>
                    <div class="stat-label">Avg Rating</div>
                </div>
                <div class="stat-box positive">
                    <div class="stat-value">+5%</div>
                    <div class="stat-label">Improvement</div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="custom-btn report-btn" onclick="window.location.href='${pageContext.request.contextPath}/reports'">
                    <span class="btn-icon">ðŸ“Š</span>
                    <span>Detailed Report</span>
                </button>
                <button class="custom-btn schedule-btn" onclick="window.location.href='${pageContext.request.contextPath}/scheduleReview'">
                    <span class="btn-icon">ðŸ“…</span>
                    <span>Schedule Review</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const barCtx = document.getElementById('barChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['Completed', 'In Progress', 'Pending', 'Overdue'],
                    datasets: [{
                        label: 'Tasks',
                        data: [
                            ${completedTasksCount},
                            ${inProgressTasksCount},
                            ${pendingTasksCount},
                            ${overdueTasksCount}
                        ],
                        backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Excellent', 'Good', 'Average', 'Poor'],
                    datasets: [{
                        data: [
                            ${performanceDistribution['Excellent'] != null ? performanceDistribution['Excellent'] : 0},
                            ${performanceDistribution['Good'] != null ? performanceDistribution['Good'] : 0},
                            ${performanceDistribution['Average'] != null ? performanceDistribution['Average'] : 0},
                            ${performanceDistribution['Poor'] != null ? performanceDistribution['Poor'] : 0}
                        ],
                        backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        });
    </script>
</body>
</html>
