<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>

<%@ taglib uri="http://java.sun.com/jsp/jstl/core" prefix="c" %>
<%@ taglib uri="http://java.sun.com/jsp/jstl/fmt" prefix="fmt" %>


<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Dawn Airline Staff Dashboard</title>
    <link rel="stylesheet" href="${pageContext.request.contextPath}/css/staff.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .progress-bar {
            background-color: #e0e0e0;
            border-radius: 4px;
            margin: 5px 0;
            height: 20px;
        }
        .progress {
            height: 100%;
            border-radius: 4px;
            text-align: center;
            color: white;
            font-size: 12px;
            line-height: 20px;
        }
        .excellent { background-color: #4CAF50; }
        .good { background-color: #2196F3; }
        .average { background-color: #FFC107; }
        .poor { background-color: #F44336; }
        .stat-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            margin: 10px;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        .positive { color: #4CAF50; }
        .negative { color: #F44336; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h2>Dawn Airline</h2>
        <ul>
            <li><a href="${pageContext.request.contextPath}/staffDashboard" class="active">Dashboard</a></li>
            <li><a href="${pageContext.request.contextPath}/employees">Employees</a></li>
            <li><a href="${pageContext.request.contextPath}/tasks">Tasks</a></li>
            <li><a href="${pageContext.request.contextPath}/reports">Reports</a></li>
            <li><a href="${pageContext.request.contextPath}/settings">Settings</a></li>
        </ul>
    </div>

    <div class="main-content">
        <h2>Welcome, <c:out value="${staff.firstName}"/> <c:out value="${staff.lastName}"/>!</h2>

        <div class="cards">
            <div class="card">
                <h3>Total Employees</h3>
                <p><fmt:formatNumber value="${totalEmployees}"/></p>
            </div>
            <div class="card">
                <h3>Total Hours</h3>
                <p><fmt:formatNumber value="${totalHours}" maxFractionDigits="2"/></p>
            </div>
            <div class="card">
                <h3>Active Tasks</h3>
                <p><fmt:formatNumber value="${activeTasks}"/></p>
            </div>
            <div class="card">
                <h3>Pending Tasks</h3>
                <p><fmt:formatNumber value="${pendingTasks}"/></p>
            </div>
        </div>

        <div class="chart-row">
            <div class="card chart-card">
                <h3>Tasks Overview</h3>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
            <div class="card chart-card">
                <h3>Performance Summary</h3>
                <div class="chart-container">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card performance-card">
            <h3>Recent Attendance</h3>
            <div class="attendance-list">
                <table>
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Clock In</th>
                            <th>Clock Out</th>
                            <th>Status</th>
                            <th>Hours</th>
                        </tr>
                    </thead>
                    <tbody>
                        <c:forEach items="${recentAttendance}" var="attendance">
                            <tr>
                                <td><fmt:formatDate value="${attendance.date}" pattern="MMM dd, yyyy"/></td>
                                <td><fmt:formatDate value="${attendance.clockIn}" pattern="HH:mm"/></td>
                                <td><fmt:formatDate value="${attendance.clockOut}" pattern="HH:mm"/></td>
                                <td><c:out value="${attendance.status}"/></td>
                                <td><fmt:formatNumber value="${attendance.workingHours}" maxFractionDigits="2"/></td>
                            </tr>
                        </c:forEach>
                    </tbody>
                </table>
            </div>
            
            <h3>Performance Overview</h3>
            <div class="performance-grid">
                <div class="performance-bars">
                    <c:forEach items="${performanceDistribution}" var="entry">
                        <div class="performance-item">
                            <span><c:out value="${entry.key}"/></span>
                            <div class="progress-bar">
                                <div class="progress ${entry.key.toLowerCase()}" 
                                     style="width: <fmt:formatNumber value="${entry.value * 10}" maxFractionDigits="0"/>%">
                                    <fmt:formatNumber value="${entry.value * 10}" maxFractionDigits="0"/>%
                                </div>
                            </div>
                        </div>
                    </c:forEach>
                </div>
                <div class="performance-stats">
                    <div class="stat-box">
                        <div class="stat-value">
                            <c:if test="${not empty topPerformer}">
                                <fmt:formatNumber value="${topPerformer.performanceScore}" maxFractionDigits="0"/>%
                            </c:if>
                        </div>
                        <div class="stat-label">Top Performer</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value">
                            <fmt:formatNumber value="${avgRating}" maxFractionDigits="0"/>%
                        </div>
                        <div class="stat-label">Avg Rating</div>
                    </div>
                    <div class="stat-box positive">
                        <div class="stat-value">+5%</div>
                        <div class="stat-label">Improvement</div>
                    </div>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="custom-btn report-btn" onclick="window.location.href='${pageContext.request.contextPath}/reports'">
                    <span class="btn-icon">ðŸ“Š</span>
                    <span>Detailed Report</span>
                </button>
                <button class="custom-btn schedule-btn" onclick="window.location.href='${pageContext.request.contextPath}/scheduleReview'">
                    <span class="btn-icon">ðŸ“…</span>
                    <span>Schedule Review</span>
                </button>
            </div>
        </div>
    </div>

    <script>
    //<![CDATA[
        document.addEventListener('DOMContentLoaded', function() {
            // Bar Chart - Tasks by Status
            const barCtx = document.getElementById('barChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['Completed', 'In Progress', 'Pending', 'Overdue'],
                    datasets: [{
                        label: 'Tasks',
                        data: [
                            ${completedTasksCount},
                            ${inProgressTasksCount},
                            ${pendingTasksCount},
                            ${overdueTasksCount}
                        ],
                        backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Pie Chart - Performance Distribution
            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Excellent', 'Good', 'Average', 'Poor'],
                    datasets: [{
                        data: [
                            ${performanceDistribution.getOrDefault("Excellent", 0)},
                            ${performanceDistribution.getOrDefault("Good", 0)},
                            ${performanceDistribution.getOrDefault("Average", 0)},
                            ${performanceDistribution.getOrDefault("Poor", 0)}
                        ],
                        backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        });
    //]]>
    </script>
</body>
</html>